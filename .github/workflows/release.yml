name: Release to Maven Central

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: '8.4'
        
    - name: Build with Gradle
      run: gradle build
      
    - name: Run tests
      run: gradle test
      
    - name: Generate GPG key for signing
      run: |
        # Generate GPG key automatically for this build
        gpg --batch --gen-key --pinentry-mode loopback << EOF
        %echo Generating GPG key for Maven Central
        Key-Type: RSA
        Key-Length: 4096
        Subkey-Type: RSA
        Subkey-Length: 4096
        Name-Real: Copybara Team
        Name-Email: team@copybara.com
        Expire-Date: 0
        Passphrase: temp-signing-key
        %commit
        %echo Done
        EOF
        
        # Export the key ID for later use
        GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | sed 's/.*\/\([A-F0-9]*\).*/\1/')
        echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
        
        # Upload public key to keyserver (ignore errors)
        gpg --keyserver keyserver.ubuntu.com --send-keys $GPG_KEY_ID || true
        
    - name: Publish to Maven Central
      env:
        OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
      run: |
        echo "user ${{ secrets.OSSRH_USERNAME }}"
        echo "pass ${{ secrets.OSSRH_PASSWORD }}"

        gradle publishToSonatype closeAndReleaseSonatypeStagingRepository \
          -PossrhUsername="$OSSRH_USERNAME" \
          -PossrhPassword="$OSSRH_PASSWORD" \
          -Psigning.keyId="$GPG_KEY_ID" \
          -Psigning.password="temp-signing-key" \
          -Psigning.secretKeyRingFile="$HOME/.gnupg/secring.gpg" \
          --info
