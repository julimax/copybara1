# .github/workflows/release-central.yml
name: Release — Maven Central (JReleaser)

on:
  push:
    tags: ['v*']          # ej: v1.0.0
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # necesario para crear el GitHub Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true


      - name: Hacer ejecutable la wrapper
        run: chmod +x ./gradlew

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache de Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Cargar clave PGP 
        env:
          PGP_PRIVATE: ${{ secrets.SIGNING_KEY }}          # contenido de private.asc
          PGP_PASSPHRASE: ${{ secrets.SIGNING_PASSPHRASE }}
        run: |
          set -euo pipefail
          KEY_FILE="$RUNNER_TEMP/pgp-private.asc"
          printf '%s' "$PGP_PRIVATE" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "SIGNING_KEY_FILE=$KEY_FILE" >> "$GITHUB_ENV"   # <-- este nombre
          echo "SIGNING_PASSPHRASE=$PGP_PASSPHRASE" >> "$GITHUB_ENV"
      
      
      # Build + dokka + stage (publish)
      - name: Build + Dokka + stage (publish)
        run: ./gradlew --no-daemon clean build dokkaJavadoc javadocJar publishMavenPublicationToStagingRepository --scan


      # 🚀 Subir artifacts a Maven Central usando HTTP directo
      - name: Upload to Maven Central via HTTP
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        run: |
          set -e
          
          # Configuración
          NAMESPACE="io.github.julimax"
          PROJECT_NAME="copybara"
          VERSION=$(grep '^version = ' build.gradle.kts | sed 's/version = "\(.*\)"/\1/')
          BASE_URL="https://central.sonatype.com/api/v1/publisher"

          
          echo "🚀 Subiendo artifacts a Maven Central..."
          echo "   Namespace: $NAMESPACE"
          echo "   Project: $PROJECT_NAME"
          echo "   Version: $VERSION"
          
          # Debug: verificar credenciales (sin mostrar el token completo)
          echo "🔍 Debug de credenciales:"
          echo "   Username: ${OSSRH_USERNAME:-'NOT_SET'}"
          echo "   Password length: ${#OSSRH_PASSWORD}"
          echo "   Password starts with: ${OSSRH_PASSWORD:0:8}..."
          
          if [[ -z "$OSSRH_USERNAME" || -z "$OSSRH_PASSWORD" ]]; then
            echo "❌ Error: OSSRH_USERNAME o OSSRH_PASSWORD no están definidos"
            exit 1
          fi
          
          # Verificar que existan los artifacts
          JAR_FILE="build/libs/${PROJECT_NAME}-${VERSION}.jar"
          POM_FILE="build/publications/maven/pom-default.xml"
          
          if [[ ! -f "$JAR_FILE" ]]; then
            echo "❌ Error: No se encontró el JAR: $JAR_FILE"
            exit 1
          fi
          
          if [[ ! -f "$POM_FILE" ]]; then
            echo "❌ Error: No se encontró el POM: $POM_FILE"
            exit 1
          fi
          
          echo "✅ Artifacts encontrados:"
          echo "   JAR: $JAR_FILE ($(du -h $JAR_FILE | cut -f1))"
          echo "   POM: $POM_FILE ($(du -h $POM_FILE | cut -f1))"
          
          # Crear bundle temporal con estructura de directorios correcta
          BUNDLE_ROOT="build/maven-central-bundle"
          BUNDLE_DIR="$BUNDLE_ROOT/io/github/julimax/${PROJECT_NAME}/${VERSION}"
          mkdir -p "$BUNDLE_DIR"
          
          # Copiar artifacts al bundle con nombres correctos
          cp "$JAR_FILE" "$BUNDLE_DIR/${PROJECT_NAME}-${VERSION}.jar"
          cp "$POM_FILE" "$BUNDLE_DIR/${PROJECT_NAME}-${VERSION}.pom"
          
          # Generar checksums requeridos por Maven Central
          echo "🔐 Generando checksums..."
          cd "$BUNDLE_DIR"
          
          # MD5 checksums (solo el hash, sin filename)
          md5sum "${PROJECT_NAME}-${VERSION}.jar" | cut -d' ' -f1 > "${PROJECT_NAME}-${VERSION}.jar.md5"
          md5sum "${PROJECT_NAME}-${VERSION}.pom" | cut -d' ' -f1 > "${PROJECT_NAME}-${VERSION}.pom.md5"
          
          # SHA1 checksums (solo el hash, sin filename)
          sha1sum "${PROJECT_NAME}-${VERSION}.jar" | cut -d' ' -f1 > "${PROJECT_NAME}-${VERSION}.jar.sha1"
          sha1sum "${PROJECT_NAME}-${VERSION}.pom" | cut -d' ' -f1 > "${PROJECT_NAME}-${VERSION}.pom.sha1"
          
          # Importar y usar la clave GPG real para firmar
          echo "🔐 Importando clave GPG..."
          gpg --batch --import "$SIGNING_KEY_FILE"
          
          # Obtener el Key ID completo (fingerprint)
          KEY_ID=$(gpg --list-secret-keys --with-colons | grep '^fpr:' | head -1 | cut -d':' -f10)
          if [[ -z "$KEY_ID" ]]; then
            # Fallback: usar el ID largo de la clave
            KEY_ID=$(gpg --list-secret-keys --with-colons | grep '^sec:' | head -1 | cut -d':' -f5)
          fi
          echo "🔑 Key ID: $KEY_ID"
          
          if [[ -z "$KEY_ID" ]]; then
            echo "❌ Error: No se pudo obtener el Key ID"
            gpg --list-secret-keys
            exit 1
          fi
          
          # Configurar GPG para modo batch
          export GPG_TTY=$(tty)
          
          # Verificar que la passphrase funcione
          echo "🔍 Verificando passphrase..."
          echo "test" | gpg --batch --yes --passphrase "$SIGNING_PASSPHRASE" --pinentry-mode loopback --local-user "$KEY_ID" --clearsign > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "✅ Passphrase válida"
          else
            echo "❌ Error: Passphrase inválida o problema con la clave"
            gpg --list-secret-keys
            exit 1
          fi
          
          # Firmar archivos con GPG usando el Key ID correcto
          echo "✍️ Firmando archivos con GPG..."
          gpg --batch --yes --passphrase "$SIGNING_PASSPHRASE" --pinentry-mode loopback --armor --detach-sign --local-user "$KEY_ID" "${PROJECT_NAME}-${VERSION}.jar"
          if [[ ! -f "${PROJECT_NAME}-${VERSION}.jar.asc" ]]; then
            echo "❌ Error: No se generó la firma del JAR"
            ls -la *.asc 2>/dev/null || echo "No hay archivos .asc"
            exit 1
          fi
          
          gpg --batch --yes --passphrase "$SIGNING_PASSPHRASE" --pinentry-mode loopback --armor --detach-sign --local-user "$KEY_ID" "${PROJECT_NAME}-${VERSION}.pom"
          if [[ ! -f "${PROJECT_NAME}-${VERSION}.pom.asc" ]]; then
            echo "❌ Error: No se generó la firma del POM"
            ls -la *.asc 2>/dev/null || echo "No hay archivos .asc"
            exit 1
          fi
          
          # Verificar signatures generadas
          echo "🔍 Verificando signatures..."
          gpg --verify "${PROJECT_NAME}-${VERSION}.jar.asc" "${PROJECT_NAME}-${VERSION}.jar"
          if [ $? -eq 0 ]; then
            echo "✅ Firma del JAR válida"
          else
            echo "❌ Error: Firma del JAR inválida"
            exit 1
          fi
          
          gpg --verify "${PROJECT_NAME}-${VERSION}.pom.asc" "${PROJECT_NAME}-${VERSION}.pom"
          if [ $? -eq 0 ]; then
            echo "✅ Firma del POM válida"
          else
            echo "❌ Error: Firma del POM inválida"
            exit 1
          fi
          
          echo "✅ Checksums y signatures generados:"
          ls -la
          
          cd - > /dev/null
          
          # Crear el bundle ZIP desde la raíz del bundle
          BUNDLE_FILE="build/${PROJECT_NAME}-${VERSION}-bundle.zip"
          cd "$BUNDLE_ROOT"
          zip -r "../$(basename "$BUNDLE_FILE")" .
          cd - > /dev/null
          
          echo "📦 Bundle creado: $BUNDLE_FILE ($(du -h $BUNDLE_FILE | cut -f1))"
          
          # Subir el bundle
          echo "📤 Subiendo bundle a Maven Central..."
          echo "🔗 URL: $BASE_URL/upload"
          echo "🔑 Authorization header: Basic ${OSSRH_USERNAME}:${OSSRH_PASSWORD:0:8}..."
          echo "📦 Bundle file: $BUNDLE_FILE"
          echo "📝 Form data: name=$PROJECT_NAME, namespace=$NAMESPACE"
          
          # Hacer la petición con más debug
          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            "$BASE_URL/upload" \
            -u "$OSSRH_USERNAME:$OSSRH_PASSWORD" \
            -H "User-Agent: GitHub-Actions-Upload/1.0" \
            -F "bundle=@$BUNDLE_FILE" \
            -F "name=$PROJECT_NAME" \
            -F "namespace=$NAMESPACE")
          
          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | head -n -1)
          
          echo "📋 Código HTTP: $HTTP_CODE"
          echo "📋 Respuesta: $RESPONSE_BODY"
          
          if [[ "$HTTP_CODE" == "201" ]]; then
            echo "✅ Bundle subido exitosamente a Maven Central"
            
            # Extraer deployment ID si está disponible
            if command -v jq >/dev/null 2>&1; then
              DEPLOYMENT_ID=$(echo "$RESPONSE_BODY" | jq -r '.deploymentId // empty' 2>/dev/null)
              if [[ -n "$DEPLOYMENT_ID" ]]; then
                echo "🆔 Deployment ID: $DEPLOYMENT_ID"
                echo "🔗 Puedes verificar el estado en: https://central.sonatype.com/publishing/deployments"
              fi
            fi
          else
            echo "❌ Error al subir bundle. Código HTTP: $HTTP_CODE"
            echo "📋 Respuesta completa: $RESPONSE_BODY"
            exit 1
          fi
          
      # 🏷️ Crear GitHub Release
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          VERSION="1.0.7"
          TAG_NAME="v$VERSION"
          
          echo "🏷️ Creando GitHub Release..."
          
          # Crear el release
          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --notes "Release $TAG_NAME - Copybara Kotlin Hello World Application" \
            --target "$GITHUB_SHA" \
            build/libs/copybara-$VERSION.jar

      # 📊 Mostrar logs de build scan después de publicar en Maven Central
      - name: Show Build Scan Logs
        if: always()
        run: |
          echo "=== Gradle Build Scan Logs ==="
          if [ -d "$RUNNER_TEMP/.gradle-actions/build-scans" ]; then
            find "$RUNNER_TEMP/.gradle-actions/build-scans" -name "*.json" 2>/dev/null | while read file; do
              echo "📄 Build Scan File: $file"
              if command -v jq >/dev/null 2>&1; then
                cat "$file" | jq '.' 2>/dev/null || cat "$file"
              else
                cat "$file"
              fi
              echo "---"
            done
          else
            echo "⚠️  Build scan directory not found at $RUNNER_TEMP/.gradle-actions/build-scans"
          fi
          
          echo "=== Alternative locations ==="
          find "$RUNNER_TEMP" -name "*build-scan*" -o -name "*.gradle-actions*" 2>/dev/null | head -10

      
      # 📊 Mostrar logs de build results después de publicar en Maven Central
      - name: Show Build Results Logs
        if: always()
        run: |
          echo "=== Gradle Build Results Logs ==="
          if [ -d "$RUNNER_TEMP/.gradle-actions/build-results" ]; then
            find "$RUNNER_TEMP/.gradle-actions/build-results" -name "*.json" 2>/dev/null | while read file; do
              echo "📄 Build Results File: $file"
              if command -v jq >/dev/null 2>&1; then
                cat "$file" | jq '.' 2>/dev/null || cat "$file"
              else
                cat "$file"
              fi
              echo "---"
            done
          else
            echo "⚠️  Build results directory not found at $RUNNER_TEMP/.gradle-actions/build-results"
          fi
          
          echo "=== Alternative locations ==="
          find "$RUNNER_TEMP" -name "*build-results*" -o -name "*.gradle-actions*" 2>/dev/null | head -10

      # 🔍 Mostrar logs detallados de JReleaser
      - name: Show JReleaser Logs
        if: always()
        run: |
          echo "=== JReleaser Logs ==="
          if [ -d "build/jreleaser" ]; then
            find build/jreleaser -name "*.log" -o -name "*.txt" | while read file; do
              echo "📄 JReleaser Log: $file"
              cat "$file"
              echo "---"
            done
          else
            echo "⚠️  JReleaser build directory not found"
          fi
          
          echo "=== Gradle Daemon Logs (últimas líneas) ==="
          find ~/.gradle/daemon -name "*.log" 2>/dev/null | head -1 | while read file; do
            echo "📄 Daemon Log: $file"
            tail -100 "$file"
          done