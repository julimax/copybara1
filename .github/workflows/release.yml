# .github/workflows/release-central.yml
name: Release â€” Maven Central (JReleaser)

on:
  push:
    tags: ['v*']          # ej: v1.0.0
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # necesario para crear el GitHub Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true


      - name: Hacer ejecutable la wrapper
        run: chmod +x ./gradlew

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache de Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Cargar clave PGP 
        env:
          PGP_PRIVATE: ${{ secrets.SIGNING_KEY }}          # contenido de private.asc
          PGP_PASSPHRASE: ${{ secrets.SIGNING_PASSPHRASE }}
        run: |
          set -euo pipefail
          KEY_FILE="$RUNNER_TEMP/pgp-private.asc"
          printf '%s' "$PGP_PRIVATE" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "SIGNING_KEY_FILE=$KEY_FILE" >> "$GITHUB_ENV"   # <-- este nombre
          echo "SIGNING_PASSPHRASE=$PGP_PASSPHRASE" >> "$GITHUB_ENV"
      
      
      # Build + dokka + stage (publish)
      - name: Build + Dokka + stage (publish)
        run: ./gradlew --no-daemon clean build dokkaJavadoc javadocJar publishMavenPublicationToStagingRepository --scan

      # ðŸ” Debug completo del directorio staging
      - name: Debug Staging Directory
        run: |
          echo "=== Estructura completa del directorio build ==="
          find build -type f -name "*.jar" -o -name "*.pom" | head -20
          
          echo "=== Contenido especÃ­fico de staging-deploy ==="
          if [ -d "build/staging-deploy" ]; then
            find build/staging-deploy -type f | head -20
            echo "ðŸ“Š Total de archivos en staging:"
            find build/staging-deploy -type f | wc -l
          else
            echo "âŒ build/staging-deploy NO EXISTE"
          fi
          
          echo "=== Verificar estructura Maven esperada ==="
          ls -la build/staging-deploy/io/github/julimax/copybara/1.0.6/ 2>/dev/null || echo "âš ï¸ Estructura Maven no encontrada"
          
          echo "=== Contenido completo de build/staging-deploy ==="
          if [ -d "build/staging-deploy" ]; then
            tree build/staging-deploy 2>/dev/null || find build/staging-deploy -type f -exec ls -la {} \;
          fi

      # ðŸš€ Publica en Maven Central y crea GitHub Release
      - name: JReleaser â€” Full Release (Central + GitHub Release)
        env:
          # Credenciales del Central Publisher Portal (Sonatype)
          JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          # Token para crear el GitHub Release (puede ser el GITHUB_TOKEN por defecto)
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew -Prelease --no-daemon jreleaserFullRelease

      # ðŸ“Š Mostrar logs de build scan despuÃ©s de publicar en Maven Central
      - name: Show Build Scan Logs
        if: always()
        run: |
          echo "=== Gradle Build Scan Logs ==="
          if [ -d "$RUNNER_TEMP/.gradle-actions/build-scans" ]; then
            find "$RUNNER_TEMP/.gradle-actions/build-scans" -name "*.json" 2>/dev/null | while read file; do
              echo "ðŸ“„ Build Scan File: $file"
              if command -v jq >/dev/null 2>&1; then
                cat "$file" | jq '.' 2>/dev/null || cat "$file"
              else
                cat "$file"
              fi
              echo "---"
            done
          else
            echo "âš ï¸  Build scan directory not found at $RUNNER_TEMP/.gradle-actions/build-scans"
          fi
          
          echo "=== Alternative locations ==="
          find "$RUNNER_TEMP" -name "*build-scan*" -o -name "*.gradle-actions*" 2>/dev/null | head -10

      
      # ðŸ“Š Mostrar logs de build results despuÃ©s de publicar en Maven Central
      - name: Show Build Results Logs
        if: always()
        run: |
          echo "=== Gradle Build Results Logs ==="
          if [ -d "$RUNNER_TEMP/.gradle-actions/build-results" ]; then
            find "$RUNNER_TEMP/.gradle-actions/build-results" -name "*.json" 2>/dev/null | while read file; do
              echo "ðŸ“„ Build Results File: $file"
              if command -v jq >/dev/null 2>&1; then
                cat "$file" | jq '.' 2>/dev/null || cat "$file"
              else
                cat "$file"
              fi
              echo "---"
            done
          else
            echo "âš ï¸  Build results directory not found at $RUNNER_TEMP/.gradle-actions/build-results"
          fi
          
          echo "=== Alternative locations ==="
          find "$RUNNER_TEMP" -name "*build-results*" -o -name "*.gradle-actions*" 2>/dev/null | head -10

      # ðŸ” Mostrar logs detallados de JReleaser
      - name: Show JReleaser Logs
        if: always()
        run: |
          echo "=== JReleaser Logs ==="
          if [ -d "build/jreleaser" ]; then
            find build/jreleaser -name "*.log" -o -name "*.txt" | while read file; do
              echo "ðŸ“„ JReleaser Log: $file"
              cat "$file"
              echo "---"
            done
          else
            echo "âš ï¸  JReleaser build directory not found"
          fi
          
          echo "=== Gradle Daemon Logs (Ãºltimas lÃ­neas) ==="
          find ~/.gradle/daemon -name "*.log" 2>/dev/null | head -1 | while read file; do
            echo "ðŸ“„ Daemon Log: $file"
            tail -100 "$file"
          done