# Repo B â€” .circleci/config.yml
version: 2.1

parameters:
  message:
    type: string
    default: "Hello World"

jobs:
  print:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Who triggered me?
          command: |
            sudo apt-get update -y && sudo apt-get install -y jq
            curl -sS -H "Circle-Token: ${CIRCLE_TOKEN}" \
              "https://circleci.com/api/v2/pipeline/${CIRCLE_PIPELINE_ID}" \
            | jq -r '"actor=\(.trigger.actor.login) type=\(.trigger.type) created_at=\(.created_at)"'
      - run:
          name: Print message
          command: echo "<< pipeline.parameters.message >>"
          
      - run:
          name: Print Logs
          command: |
            # 1) Get latest pipeline id of A
            echo "get pipeline id"
            PIPE_ID=$(curl -s -H "Circle-Token: $CIRCLE_TOKEN" \
              "https://circleci.com/api/v2/project/circleci/2d9dcac2-9735-4929-b3d2-bb133465bc4d/55d9b29f-731e-40df-8c77-170ec5493e4b/pipeline?branch=main" \
              | jq -r '.items[0].id')
            
            # 2) Get workflow id
            echo "get workflow id"
            WF_ID=$(curl -s -H "Circle-Token: $CIRCLE_TOKEN" \
              "https://circleci.com/api/v2/pipeline/$PIPE_ID/workflow" \
              | jq -r '.items[0].id')
            
            # 3) Get job number
            echo "get job id"
            JOB_NUM=$(curl -s -H "Circle-Token: $CIRCLE_TOKEN" \
              "https://circleci.com/api/v2/workflow/$WF_ID/job" \
              | jq -r '.items[0].job_number')
            
            # 4) Get step log
            echo "get log id"
            OUTPUT_URL=$(curl -s -H "Circle-Token: $CIRCLE_TOKEN" \
              "https://circleci.com/api/v1.1/project/github/julimax/copybara1/$JOB_NUM" \
              | jq -r '.steps[] | select(.name=="Previous echo") | .actions[0].output_url')
            
            # 5) Print the log
            curl -s -H "Circle-Token: $CIRCLE_TOKEN" "$OUTPUT_URL" | jq -r '.[].message'


workflows:
  example:
    jobs:
      - print
